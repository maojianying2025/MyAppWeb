<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>æˆ‘çš„APPï¼ˆç½‘é¡µç‰ˆï¼‰</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #f5f5f5; min-height: 100vh; }
        .loading-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            z-index: 9999;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; color: #333; }
        .loading-error { color: #dc3545; margin-top: 10px; display: none; }
        #app-content { display: none; padding: 20px; }
        @supports (-webkit-touch-callout: none) {
            .loading-container { padding-bottom: constant(safe-area-inset-bottom); }
        }
    </style>
</head>
<body>
    <div class="loading-container" id="loadingBox">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loadingText">æ­£åœ¨åŠ è½½APP...</p>
        <p class="loading-error" id="loadingError">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°</p>
    </div>
    <div id="app-content"></div>

    <script>
        const CONFIG = {
            // ä½ çš„loadConfig.jsonä¸‹è½½é“¾æ¥ï¼ˆå·²æ›¿æ¢ä¸ºæ­£ç¡®IDï¼‰
            LOAD_CONFIG_URL: "https://drive.google.com/uc?export=download&id=1LU_nHmT87PiuuC2xAt8RFj1TJzPjo5Yx",
            // æ”¹ç”¨æ›´ç¨³å®šçš„è·¨åŸŸä»£ç†
            CORS_PROXY: "https://api.allorigins.win/raw?url="
        };

        // ä¿®å¤è·¨åŸŸä»£ç†çš„URLç¼–ç é—®é¢˜
        async function loadFile(rawUrl) {
            // å¯¹åŸURLè¿›è¡Œç¼–ç ï¼Œé¿å…ä»£ç†è§£æé”™è¯¯
            const encodedUrl = encodeURIComponent(rawUrl);
            const proxyUrl = `${CONFIG.CORS_PROXY}${encodedUrl}`;
            
            const res = await fetch(proxyUrl);
            if (!res.ok) {
                throw new Error(`æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š${res.status} ${res.statusText}ï¼ˆURLï¼š${proxyUrl}ï¼‰`);
            }
            return res.text();
        }

        async function loadJS(downloadUrl) {
            const jsCode = await loadFile(downloadUrl);
            const script = document.createElement('script');
            script.textContent = jsCode;
            document.body.appendChild(script);
            console.log("âœ… JSåŠ è½½å®Œæˆï¼š", downloadUrl);
        }

        async function loadCSS(downloadUrl) {
            const cssCode = await loadFile(downloadUrl);
            const style = document.createElement('style');
            style.textContent = cssCode;
            document.head.appendChild(style);
            console.log("âœ… CSSåŠ è½½å®Œæˆï¼š", downloadUrl);
        }

        async function loadApp() {
            const loadingText = document.getElementById("loadingText");
            const loadingError = document.getElementById("loadingError");
            
            try {
                loadingText.textContent = "åŠ è½½é…ç½®æ–‡ä»¶...";
                const configText = await loadFile(CONFIG.LOAD_CONFIG_URL);
                console.log("ğŸ” é…ç½®æ–‡ä»¶å†…å®¹ï¼š", configText); // æ‰“å°å†…å®¹ï¼Œæ£€æŸ¥æ˜¯å¦æ­£ç¡®
                
                // è§£æJSONå‰å…ˆæ¸…ç†å¯èƒ½çš„BOMå¤´
                const cleanConfigText = configText.replace(/^\uFEFF/, '');
                const loadConfig = JSON.parse(cleanConfigText);

                loadingText.textContent = "åŠ è½½æ ¸å¿ƒé€»è¾‘...";
                for (const item of loadConfig.entities || []) {
                    await loadJS(item.downloadUrl);
                }

                loadingText.textContent = "åŠ è½½ç»„ä»¶èµ„æº...";
                for (const item of loadConfig.components || []) {
                    item.downloadUrl.endsWith(".css") ? await loadCSS(item.downloadUrl) : await loadJS(item.downloadUrl);
                }

                loadingText.textContent = "åŠ è½½é¡µé¢å†…å®¹...";
                for (const item of loadConfig.pages || []) {
                    item.downloadUrl.endsWith(".css") ? await loadCSS(item.downloadUrl) : await loadJS(item.downloadUrl);
                }

                loadingText.textContent = "å¯åŠ¨æˆåŠŸï¼";
                setTimeout(() => {
                    document.getElementById("loadingBox").style.display = "none";
                    document.getElementById("app-content").style.display = "block";
                    if (window.initApp) window.initApp();
                }, 800);

            } catch (err) {
                console.error("âŒ åŠ è½½å¤±è´¥è¯¦æƒ…ï¼š", err.stack);
                loadingText.style.display = "none";
                loadingError.style.display = "block";
                loadingError.textContent = `åŠ è½½å¤±è´¥ï¼š${err.message}`;
            }
        }

        window.addEventListener("DOMContentLoaded", loadApp);
        document.getElementById("loadingError").addEventListener("click", () => {
            document.getElementById("loadingError").style.display = "none";
            document.getElementById("loadingText").style.display = "block";
            document.getElementById("loadingText").textContent = "é‡æ–°åŠ è½½ä¸­...";
            loadApp();
        });
    </script>
</body>
</html>
