<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
    <!-- 移动端适配：禁止缩放、适配刘海屏 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>我的APP（网页版）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #f5f5f5; min-height: 100vh; }
        /* 加载提示样式 */
        .loading-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            z-index: 9999;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; color: #333; }
        .loading-error { color: #dc3545; margin-top: 10px; display: none; }
        /* APP内容容器 */
        #app-content { display: none; padding: 20px; }
        /* 适配iOS Safari样式 */
        @supports (-webkit-touch-callout: none) {
            .loading-container { padding-bottom: constant(safe-area-inset-bottom); }
        }
    </style>
</head>
<body>
    <!-- 加载界面 -->
    <div class="loading-container" id="loadingBox">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loadingText">正在加载APP...</p>
        <p class="loading-error" id="loadingError">加载失败，请检查网络后刷新</p>
    </div>

    <!-- APP内容容器 -->
    <div id="app-content"></div>

    <script>
        // 1. 配置项（你的Google Drive信息）
        const CONFIG = {
            GOOGLE_DRIVE_FOLDER_ID: "11QTqs_SHvlet9XYUt6mBUggHABSV5GBj",
            LOAD_CONFIG_FILE: "loadConfig.json",
            // 解决Google Drive跨域：使用免费跨域代理（无需自己部署）
            CORS_PROXY: "https://corsproxy.io/?"
        };

        // 2. 获取Google Drive文件ID（适配网页端跨域）
        async function getGoogleDriveFileId(relativeFilePath) {
            try {
                // 拼接Google Drive API请求（带跨域代理）
                const apiUrl = `${CONFIG.CORS_PROXY}https://www.googleapis.com/drive/v3/files?q='${CONFIG.GOOGLE_DRIVE_FOLDER_ID}'+in+parents+and+name='${relativeFilePath}'&fields=files(id)&key=AIzaSyB52jYkG9dZ9t5xXW4lG_2X6zU6Kp8Z2b0`;
                const res = await fetch(apiUrl);
                const data = await res.json();
                if (!data.files || data.files.length === 0) throw new Error(`未找到文件：${relativeFilePath}`);
                return data.files[0].id;
            } catch (err) {
                console.error("获取文件ID失败：", err);
                throw err;
            }
        }

        // 3. 获取Google Drive文件下载链接（带跨域代理）
        async function getDownloadUrl(relativeFilePath) {
            const fileId = await getGoogleDriveFileId(relativeFilePath);
            return `${CONFIG.CORS_PROXY}https://drive.google.com/uc?export=download&id=${fileId}`;
        }

        // 4. 加载JS文件（适配网页端）
        async function loadJS(path) {
            const url = await getDownloadUrl(path);
            const res = await fetch(url);
            if (!res.ok) throw new Error(`JS加载失败：${path}`);
            const code = await res.text();
            const script = document.createElement('script');
            script.textContent = code;
            document.body.appendChild(script);
        }

        // 5. 加载CSS文件（适配网页端）
        async function loadCSS(path) {
            const url = await getDownloadUrl(path);
            const res = await fetch(url);
            if (!res.ok) throw new Error(`CSS加载失败：${path}`);
            const code = await res.text();
            const style = document.createElement('style');
            style.textContent = code;
            document.head.appendChild(style);
        }

        // 6. 核心加载逻辑
        async function loadApp() {
            const loadingText = document.getElementById("loadingText");
            const loadingError = document.getElementById("loadingError");
            try {
                // 加载配置文件
                loadingText.textContent = "加载配置文件...";
                const configUrl = await getDownloadUrl(CONFIG.LOAD_CONFIG_FILE);
                const configRes = await fetch(configUrl);
                const loadConfig = await configRes.json();

                // 加载业务模型
                loadingText.textContent = "加载核心逻辑...";
                for (const file of loadConfig.entities) await loadJS(file);

                // 加载组件
                loadingText.textContent = "加载组件资源...";
                for (const file of loadConfig.components) {
                    file.endsWith(".css") ? await loadCSS(file) : await loadJS(file);
                }

                // 加载页面
                loadingText.textContent = "加载页面内容...";
                for (const file of loadConfig.pages) {
                    file.endsWith(".css") ? await loadCSS(file) : await loadJS(file);
                }

                // 加载完成
                loadingText.textContent = "启动成功！";
                setTimeout(() => {
                    document.getElementById("loadingBox").style.display = "none";
                    document.getElementById("app-content").style.display = "block";
                    // 触发APP初始化（若你的代码中有initApp函数）
                    if (window.initApp) window.initApp();
                }, 800);
            } catch (err) {
                loadingText.style.display = "none";
                loadingError.style.display = "block";
                loadingError.textContent = `加载失败：${err.message}`;
                console.error("APP加载失败：", err);
            }
        }

        // 页面加载完成后启动
        window.addEventListener("DOMContentLoaded", loadApp);
        // 支持刷新重试
        document.getElementById("loadingError").addEventListener("click", () => {
            document.getElementById("loadingError").style.display = "none";
            document.getElementById("loadingText").style.display = "block";
            document.getElementById("loadingText").textContent = "重新加载中...";
            loadApp();
        });
    </script>
</body>
</html>