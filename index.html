<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>My APP (Web Version)</title>

    <!-- 核心依赖库 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #f5f5f5; min-height: 100vh; }
        .loading-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            z-index: 9999;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; color: #333; }
        .loading-error { color: #dc3545; margin-top: 10px; display: none; }
        #app-content { display: none; padding: 0; width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div class="loading-container" id="loadingBox">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loadingText">Loading APP...</p>
        <p class="loading-error" id="loadingError">Load failed, check console</p>
    </div>
    <div id="app-content"></div>

    <script>
        // 核心配置
        const CONFIG = {
            BASE_URL: "https://maojianying2025.github.io/MyAppWeb",
            DEFAULT_PAGE: "ConfigCenter.js", // 默认页面
            COMMON_COMPONENTS_PATH: "MyAPP/components/global/CommonComponents.js" // 通用组件路径
        };

        // 通用文件加载函数
        async function loadFile(path) {
            const cacheBuster = `?v=${Date.now()}`;
            const url = `${CONFIG.BASE_URL}/${path}${cacheBuster}`;
            const res = await fetch(url);
            if (!res.ok) throw new Error(`Load failed: ${res.status} (${url})`);
            return res.text();
        }

        // JSON加载函数（实体文件）
        async function loadJSON(path, globalName) {
            try {
                const jsonObj = JSON.parse(await loadFile(path));
                window[globalName] = jsonObj;
                console.log(`✅ JSON loaded: ${globalName}`);
                return jsonObj;
            } catch (err) {
                console.error(`❌ JSON load error: ${path}`, err);
                throw err;
            }
        }

        // JS加载函数（适配ES Module + 全局组件）
        async function loadJS(path, globalName = null) {
            try {
                const jsCode = await loadFile(path);
                // 方式1：需要全局挂载的JS（Page/Component）
                if (globalName) {
                    const blob = new Blob([jsCode], { type: 'text/javascript' });
                    const url = URL.createObjectURL(blob);
                    const module = await import(url);
                    window[globalName] = module.default || module;
                    URL.revokeObjectURL(url);
                    console.log(`✅ JS loaded: ${globalName}`);
                } 
                // 方式2：直接执行的JS（通用组件/全局逻辑）
                else {
                    const script = document.createElement('script');
                    script.textContent = jsCode;
                    script.type = "module";
                    script.crossOrigin = "anonymous";
                    document.body.appendChild(script);
                    console.log(`✅ JS loaded: ${path}`);
                }
                return jsCode;
            } catch (err) {
                console.error(`❌ JS load error: ${path}`, err);
                throw err;
            }
        }

        // 渲染指定页面（通用方法）
        async function renderPage(pageName) {
            const appContent = document.getElementById("app-content");
            try {
                // 加载页面文件
                await loadJS(`MyAPP/pages/${pageName}`, pageName.replace('.js', ''));
                // 调用页面的render方法
                const pageGlobalName = pageName.replace('.js', '');
                if (window[pageGlobalName]?.render) {
                    window[pageGlobalName].render();
                } else {
                    // 兜底渲染（自动创建React组件）
                    if (window[pageGlobalName]) {
                        ReactDOM.render($r(window[pageGlobalName]), appContent);
                    } else {
                        appContent.innerHTML = `<div class="p-4 text-center">✅ ${pageName} loaded, no render function</div>`;
                    }
                }
                console.log(`✅ Page rendered: ${pageName}`);
            } catch (err) {
                appContent.innerHTML = `
                    <div class="p-4 text-center text-red-500">
                        <h2>❌ Load failed: ${pageName}</h2>
                        <p class="text-sm mt-2">${err.message}</p>
                    </div>
                `;
                console.error(`❌ Page render error: ${pageName}`, err);
            }
        }

        // 初始化APP
        async function initApp() {
            const loadingText = document.getElementById("loadingText");
            const loadingError = document.getElementById("loadingError");
            
            try {
                // 1. 加载通用组件库（优先加载）
                loadingText.textContent = "Loading common components...";
                await loadJS(CONFIG.COMMON_COMPONENTS_PATH);

                // 2. 加载实体JSON文件
                loadingText.textContent = "Loading entities...";
                const entities = [
                    { path: "MyAPP/entities/Customer.json", globalName: "Customer" },
                    { path: "MyAPP/entities/ICCID.json", globalName: "ICCID" },
                    { path: "MyAPP/entities/Organization.json", globalName: "Organization" },
                    { path: "MyAPP/entities/Permission.json", globalName: "Permission" },
                    { path: "MyAPP/entities/Program.json", globalName: "Program" },
                    { path: "MyAPP/entities/Region.json", globalName: "Region" },
                    { path: "MyAPP/entities/Role.json", globalName: "Role" },
                    { path: "MyAPP/entities/SalesSchedule.json", globalName: "SalesSchedule" },
                    { path: "MyAPP/entities/Task.json", globalName: "Task" },
                    { path: "MyAPP/entities/TPA.json", globalName: "TPA" },
                    { path: "MyAPP/entities/TPABilling.json", globalName: "TPABilling" }
                ];
                for (const item of entities) await loadJSON(item.path, item.globalName);

                // 3. 加载配置文件（可选）
                loadingText.textContent = "Loading config...";
                const loadConfig = JSON.parse(await loadFile("loadConfig.json"));

                // 4. 加载业务组件
                loadingText.textContent = "Loading components...";
                if (loadConfig.components) {
                    for (const item of loadConfig.components) {
                        let componentPath = "";
                        if (["CompactFlowConfig.js", "CompactTaskConfig.js", "FlowConfiguration.js", "ICCIDManager.js", "ModuleLibrary.js", "OrganizationManager.js", "ProgramManager.js", "RegionManager.js", "RoleManager.js", "RolePermissionManager.js", "TaskConfiguration.js", "UserPermissionManager.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/config/${item.name}`;
                        } else if (["BulkEditCustomersModal.js", "CreateCustomerModal.js", "ExportCustomersModal.js", "ImportCustomersModal.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/crm/${item.name}`;
                        } else if (["CalenderModal.js", "CalenderWidget.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/dashboard/${item.name}`;
                        } else if (["TPAForm.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/tpa/${item.name}`;
                        }
                        if (componentPath) await loadJS(componentPath, item.name.replace('.js', ''));
                    }
                }

                // 5. 渲染默认页面
                loadingText.textContent = "Starting APP...";
                setTimeout(() => {
                    document.getElementById("loadingBox").style.display = "none";
                    document.getElementById("app-content").style.display = "block";
                    renderPage(CONFIG.DEFAULT_PAGE);
                }, 500);

            } catch (err) {
                console.error("❌ APP init error", err.stack);
                loadingText.style.display = "none";
                loadingError.style.display = "block";
                loadingError.textContent = `Load failed: ${err.message}`;
            }
        }

        // 页面加载完成后初始化
        window.addEventListener("DOMContentLoaded", initApp);
        
        // 错误重试
        document.getElementById("loadingError").addEventListener("click", () => {
            document.getElementById("loadingError").style.display = "none";
            document.getElementById("loadingText").style.display = "block";
            document.getElementById("loadingText").textContent = "Reloading...";
            initApp();
        });
    </script>
</body>
</html>
