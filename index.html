<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>My APP (Web Version)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #f5f5f5; min-height: 100vh; }
        .loading-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #fff;
            z-index: 9999;
        }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; color: #333; }
        .loading-error { color: #dc3545; margin-top: 10px; display: none; }
        #app-content { display: none; padding: 20px; width: 100%; height: 100vh; }
        @supports (-webkit-touch-callout: none) {
            .loading-container { padding-bottom: constant(safe-area-inset-bottom); }
        }
    </style>
</head>
<body>
    <div class="loading-container" id="loadingBox">
        <div class="loading-spinner"></div>
        <p class="loading-text" id="loadingText">Loading APP...</p>
        <p class="loading-error" id="loadingError">Load failed, check console</p>
    </div>
    <div id="app-content"></div>

    <script>
        // Configuration: GitHub Pages base URL + Default page to open
        const CONFIG = {
            BASE_URL: "https://maojianying2025.github.io/MyAppWeb",
            DEFAULT_PAGE: "ConfigCenter.js" // 要默认打开的页面文件名
        };

        // Load file with cache busting
        async function loadFile(path) {
            const cacheBuster = `?v=${Date.now()}`;
            const url = `${CONFIG.BASE_URL}/${path}${cacheBuster}`;
            const res = await fetch(url);
            
            if (!res.ok) {
                throw new Error(`File load failed: ${res.status} (URL: ${url})`);
            }
            return res.text();
        }

        // Load JavaScript file (global mount mode)
        async function loadJS(path, globalName = null) {
            try {
                const jsCode = await loadFile(path);
                // Mount to window if globalName is provided
                if (globalName) {
                    window[globalName] = eval(jsCode);
                    console.log(`✅ JS mounted to global: window.${globalName} (${path})`);
                } else {
                    const script = document.createElement('script');
                    script.textContent = jsCode;
                    document.body.appendChild(script);
                    console.log("✅ JS loaded successfully: ", path);
                }
                return jsCode; // 返回代码，用于后续渲染
            } catch (err) {
                console.error("❌ Failed to load JS: ", path, err);
                throw err;
            }
        }

        // Load CSS file (reserved for future use)
        async function loadCSS(path) {
            const cssCode = await loadFile(path);
            const style = document.createElement('style');
            style.textContent = cssCode;
            document.head.appendChild(style);
            console.log("✅ CSS loaded successfully: ", path);
        }

        // Render specified page to app content
        async function renderDefaultPage() {
            const appContent = document.getElementById("app-content");
            try {
                // 1. 加载默认页面的JS代码
                const pagePath = `MyAPP/pages/${CONFIG.DEFAULT_PAGE}`;
                const pageCode = await loadJS(pagePath);
                
                // 2. 尝试执行页面渲染逻辑（适配两种常见场景）
                // 场景1：页面代码有render()函数
                if (window[CONFIG.DEFAULT_PAGE.replace(".js", "")]?.render) {
                    appContent.innerHTML = window[CONFIG.DEFAULT_PAGE.replace(".js", "")].render();
                } 
                // 场景2：页面代码直接生成HTML内容（挂载到全局）
                else if (window.pageContent) {
                    appContent.innerHTML = window.pageContent;
                } 
                // 场景3：兜底 - 执行页面代码后自动渲染
                else {
                    eval(pageCode); // 执行页面代码
                    // 若页面代码内有主动插入DOM的逻辑，会自动生效
                }

                console.log(`✅ Default page rendered: ${CONFIG.DEFAULT_PAGE}`);
            } catch (err) {
                appContent.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h2>Failed to load default page: ${CONFIG.DEFAULT_PAGE}</h2>
                        <p>Error: ${err.message}</p>
                    </div>
                `;
                console.error("❌ Failed to render default page: ", err);
            }
        }

        // Core APP loading logic
        async function loadApp() {
            const loadingText = document.getElementById("loadingText");
            const loadingError = document.getElementById("loadingError");
            
            try {
                // Step 1: Preload core entities (mount to window)
                loadingText.textContent = "Loading core modules...";
                const coreEntities = [
                    { path: "MyAPP/entities/Customer.js", globalName: "Customer" },
                    { path: "MyAPP/entities/ICCID.js", globalName: "ICCID" },
                    { path: "MyAPP/entities/Organization.js", globalName: "Organization" },
                    { path: "MyAPP/entities/Permission.js", globalName: "Permission" },
                    { path: "MyAPP/entities/Program.js", globalName: "Program" },
                    { path: "MyAPP/entities/Region.js", globalName: "Region" },
                    { path: "MyAPP/entities/Role.js", globalName: "Role" },
                    { path: "MyAPP/entities/SalesSchedule.js", globalName: "SalesSchedule" },
                    { path: "MyAPP/entities/Task.js", globalName: "Task" },
                    { path: "MyAPP/entities/TPA.js", globalName: "TPA" },
                    { path: "MyAPP/entities/TPABilling.js", globalName: "TPABilling" }
                ];
                // Load all core entities and mount to window
                for (const item of coreEntities) {
                    await loadJS(item.path, item.globalName);
                }

                // Step 2: Load configuration file
                loadingText.textContent = "Loading configuration file...";
                const configText = await loadFile("loadConfig.json");
                const loadConfig = JSON.parse(configText);

                // Step 3: Load components (with subdirectories)
                loadingText.textContent = "Loading component resources...";
                if (loadConfig.components) {
                    for (const item of loadConfig.components) {
                        let componentPath = "";
                        // Match component subdirectories
                        if (["CompactFlowConfig.js", "CompactTaskConfig.js", "FlowConfiguration.js", "ICCIDManager.js", "ModuleLibrary.js", "OrganizationManager.js", "ProgramManager.js", "RegionManager.js", "RoleManager.js", "RolePermissionManager.js", "TaskConfiguration.js", "UserPermissionManager.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/config/${item.name}`;
                        } else if (["BulkEditCustomersModal.js", "CreateCustomerModal.js", "ExportCustomersModal.js", "ImportCustomersModal.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/crm/${item.name}`;
                        } else if (["CalenderModal.js", "CalenderWidget.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/dashboard/${item.name}`;
                        } else if (["TPAForm.js"].includes(item.name)) {
                            componentPath = `MyAPP/components/tpa/${item.name}`;
                        }

                        if (componentPath) {
                            item.name.endsWith(".css") ? await loadCSS(componentPath) : await loadJS(componentPath);
                        }
                    }
                }

                // Step 4: Load pages (including default page)
                loadingText.textContent = "Loading page content...";
                if (loadConfig.pages) {
                    for (const item of loadConfig.pages) {
                        let pagePath = `MyAPP/pages/${item.name}`;
                        // Fix CrmCustomer.js -> CrmCustomers.js
                        if (item.name === "CrmCustomer.js") {
                            pagePath = `MyAPP/pages/CrmCustomers.js`;
                        }
                        await loadJS(pagePath);
                    }
                }

                // Step 5: Complete loading & render default page
                loadingText.textContent = "Starting APP...";
                setTimeout(async () => {
                    document.getElementById("loadingBox").style.display = "none";
                    const appContent = document.getElementById("app-content");
                    appContent.style.display = "block";
                    
                    // 渲染默认页面
                    await renderDefaultPage();

                    // 触发initApp如果存在（兼容原有逻辑）
                    if (window.initApp) {
                        window.initApp();
                    }
                }, 800);

            } catch (err) {
                // Error handling
                console.error("❌ Load failure details: ", err.stack);
                loadingText.style.display = "none";
                loadingError.style.display = "block";
                loadingError.textContent = `Load failed: ${err.message}`;
            }
        }

        // Initialize APP when page loads
        window.addEventListener("DOMContentLoaded", loadApp);
        
        // Retry on error click
        document.getElementById("loadingError").addEventListener("click", () => {
            document.getElementById("loadingError").style.display = "none";
            document.getElementById("loadingText").style.display = "block";
            document.getElementById("loadingText").textContent = "Reloading...";
            loadApp();
        });
    </script>
</body>
</html>
